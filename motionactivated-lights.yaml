blueprint:
  name: Advanced Motion-Activated Lighting System
  description: >
    A complete automation for your smart home that combines motion control with advanced
    brightness adaptation and dynamic circadian lighting. Motion sensors trigger lights with
    intelligent timeout management, lux-based brightness adjustment, and time-period scenes.
    Everything is organized for easy configuration, flexible customization, and reliable daily operation.
  domain: automation
  
  input:
    # ============================================================================
    # LOGGING
    # ============================================================================
    enable_logging:
      name: Enable Debug Logging
      description: Log automation actions for troubleshooting
      default: false
      selector:
        boolean:
      collapsed: true
    
    log_level:
      name: Log Level
      description: Detail level for logs
      default: "info"
      selector:
        select:
          options:
            - label: "Info"
              value: "info"
            - label: "Debug"
              value: "debug"
            - label: "Warning"
              value: "warning"
      collapsed: true
    
    # ============================================================================
    # SENSORS & SWITCHES
    # ============================================================================
    motion_sensor:
      name: Motion Sensor
      description: The motion sensor that triggers this automation
      selector:
        entity:
          domain: binary_sensor
          device_class: motion
    
    target_lights:
      name: Target Lights
      description: The lights to control (can select multiple)
      selector:
        target:
          entity:
            domain: light
    
    enable_override_switch:
      name: Enable Manual Override Switch
      description: Use a switch/input_boolean to disable automation temporarily
      default: false
      selector:
        boolean:
    
    override_switch:
      name: Override Switch (Optional)
      description: When ON, automation is disabled
      default: {}
      selector:
        entity:
          domain:
            - input_boolean
            - switch
    
    # ============================================================================
    # MAIN LIGHTS BEHAVIOR
    # ============================================================================
    transition_time:
      name: Transition Time
      description: How smoothly lights fade in/out
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: seconds
    
    keep_lights_on_motion:
      name: Keep Lights On During Motion
      description: Restart timer each time motion is detected (presence extension)
      default: true
      selector:
        boolean:
    
    manual_control_timeout:
      name: Manual Override Duration
      description: Block automation after manual light control (0 = disable feature)
      default: 3600
      selector:
        number:
          min: 0
          max: 7200
          unit_of_measurement: seconds
          mode: box
    
    # ============================================================================
    # DAY LIGHTING
    # ============================================================================
    daytime_start:
      name: Daytime Start
      description: When daytime mode begins
      default: "09:00:00"
      selector:
        time:
    
    daytime_end:
      name: Daytime End
      description: When daytime mode ends
      default: "20:00:00"
      selector:
        time:
    
    daytime_brightness:
      name: Daytime Brightness
      description: Light brightness during daytime (0-100%)
      default: 80
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    
    daytime_color_temp:
      name: Daytime Color Temperature
      description: Neutral/cool light for alertness (lower = warmer)
      default: 250
      selector:
        number:
          min: 153
          max: 500
          unit_of_measurement: mired
          mode: slider
    
    daytime_timeout:
      name: Daytime Turn Off Timeout
      description: How long lights stay on after no motion
      default: 180
      selector:
        number:
          min: 30
          max: 3600
          unit_of_measurement: seconds
          mode: box
    
    # ============================================================================
    # NIGHT LIGHTING
    # ============================================================================
    night_start:
      name: Night Start
      description: When night mode begins
      default: "22:00:00"
      selector:
        time:
    
    night_end:
      name: Night End
      description: When night mode ends
      default: "06:00:00"
      selector:
        time:
    
    night_brightness:
      name: Night Brightness
      description: Light brightness during night (0-100%)
      default: 20
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    
    night_color_temp:
      name: Night Color Temperature
      description: Very warm light to preserve sleep
      default: 454
      selector:
        number:
          min: 153
          max: 500
          unit_of_measurement: mired
          mode: slider
    
    night_timeout:
      name: Night Turn Off Timeout
      description: How long lights stay on after no motion
      default: 120
      selector:
        number:
          min: 30
          max: 3600
          unit_of_measurement: seconds
          mode: box
    
    # ============================================================================
    # SNAPSHOT-RESTORE
    # ============================================================================
    enable_snapshot:
      name: Enable Scene Snapshot
      description: Remember and restore previous light state after timeout
      default: false
      selector:
        boolean:
    
    restore_previous_state:
      name: Restore Previous State
      description: Return lights to their previous state instead of turning off
      default: false
      selector:
        boolean:
    
    # ============================================================================
    # LUX & SUN
    # ============================================================================
    use_lux_sensor:
      name: Enable Lux Sensor
      description: Use ambient light sensor to adapt brightness
      default: false
      selector:
        boolean:
    
    lux_sensor:
      name: Lux Sensor (Optional)
      description: Illuminance sensor to measure ambient light
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: illuminance
    
    lux_threshold:
      name: Lux Activation Threshold
      description: Don't turn on lights if ambient light is above this value
      default: 50
      selector:
        number:
          min: 0
          max: 1000
          unit_of_measurement: lx
          mode: box
    
    bright_lux_level:
      name: Bright Environment Lux
      description: Above this lux, reduce brightness by 50%
      default: 30
      selector:
        number:
          min: 0
          max: 500
          unit_of_measurement: lx
          mode: box
    
    dim_lux_level:
      name: Dim Environment Lux
      description: Below this lux, use full brightness
      default: 10
      selector:
        number:
          min: 0
          max: 500
          unit_of_measurement: lx
          mode: box
    
    sun_condition:
      name: Sun-Based Activation
      description: Only activate when sun is in specific position
      default: "always"
      selector:
        select:
          options:
            - label: "Always Active"
              value: "always"
            - label: "Only After Sunset"
              value: "after_sunset"
            - label: "Only Before Sunrise"
              value: "before_sunrise"
            - label: "When Sun is Down"
              value: "sun_down"
    
    # ============================================================================
    # CIRCADIAN LIGHTS
    # ============================================================================
    enable_circadian:
      name: Enable Advanced Circadian Mode
      description: Smoothly transition color temperature based on time of day
      default: false
      selector:
        boolean:
    
    morning_transition_start:
      name: Morning Transition Start
      description: Begin warming up lights
      default: "06:00:00"
      selector:
        time:
    
    morning_brightness:
      name: Morning Brightness
      description: Light brightness during morning (0-100%)
      default: 40
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    
    morning_color_temp:
      name: Morning Color Temperature
      description: Warm light for gentle wake-up
      default: 370
      selector:
        number:
          min: 153
          max: 500
          unit_of_measurement: mired
          mode: slider
    
    morning_timeout:
      name: Morning Timeout
      description: Timeout duration during morning hours
      default: 300
      selector:
        number:
          min: 30
          max: 3600
          unit_of_measurement: seconds
          mode: box
    
    evening_transition_start:
      name: Evening Transition Start
      description: Begin winding down to night mode
      default: "20:00:00"
      selector:
        time:
    
    evening_brightness:
      name: Evening Brightness
      description: Light brightness during evening (0-100%)
      default: 60
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    
    evening_color_temp:
      name: Evening Color Temperature
      description: Warm light for relaxation
      default: 400
      selector:
        number:
          min: 153
          max: 500
          unit_of_measurement: mired
          mode: slider
    
    evening_timeout:
      name: Evening Timeout
      description: Timeout duration during evening hours
      default: 300
      selector:
        number:
          min: 30
          max: 3600
          unit_of_measurement: seconds
          mode: box
    
    # ============================================================================
    # FIXED TIMES
    # ============================================================================
    enable_fixed_times:
      name: Enable Fixed Time Control
      description: Disable automation during specific hours
      default: false
      selector:
        boolean:
    
    disable_start_time:
      name: Disable Start Time
      description: Automation turns off at this time
      default: "23:00:00"
      selector:
        time:
    
    disable_end_time:
      name: Disable End Time
      description: Automation turns back on at this time
      default: "06:00:00"
      selector:
        time:
    
    # ============================================================================
    # WORKDAY & FAILSAFE
    # ============================================================================
    enable_workday_mode:
      name: Enable Workday-Specific Settings
      description: Different behavior on workdays vs weekends
      default: false
      selector:
        boolean:
    
    workday_sensor:
      name: Workday Sensor (Optional)
      description: Binary sensor indicating workday (requires Workday integration)
      default: {}
      selector:
        entity:
          domain: binary_sensor
    
    workday_timeout:
      name: Workday Timeout
      description: Shorter timeout on busy workdays
      default: 120
      selector:
        number:
          min: 30
          max: 3600
          unit_of_measurement: seconds
          mode: box
    
    weekend_timeout:
      name: Weekend Timeout
      description: Longer timeout for relaxed weekends
      default: 300
      selector:
        number:
          min: 30
          max: 3600
          unit_of_measurement: seconds
          mode: box
    
    max_on_time:
      name: Maximum On Time (Failsafe)
      description: Force lights off after this duration (0 = disabled)
      default: 0
      selector:
        number:
          min: 0
          max: 14400
          unit_of_measurement: seconds
          mode: box
    
    retry_on_failure:
      name: Retry Failed Commands
      description: Retry light commands if they fail
      default: true
      selector:
        boolean:

mode: restart
max_exceeded: silent

variables:
  # Sensors & Switches
  motion_entity: !input motion_sensor
  override_enabled: !input enable_override_switch
  override_entity: !input override_switch
  
  # Lux & Sun
  use_lux: !input use_lux_sensor
  lux_entity: !input lux_sensor
  lux_threshold: !input lux_threshold
  bright_lux: !input bright_lux_level
  dim_lux: !input dim_lux_level
  sun_condition: !input sun_condition
  
  # Circadian
  enable_circadian: !input enable_circadian
  
  # Fixed Times
  enable_fixed: !input enable_fixed_times
  disable_start: !input disable_start_time
  disable_end: !input disable_end_time
  
  # Workday
  enable_workday: !input enable_workday_mode
  workday_entity: !input workday_sensor
  
  # Snapshot
  enable_snapshot: !input enable_snapshot
  restore_state: !input restore_previous_state
  
  # Logging
  debug_logging: !input enable_logging
  
  # Current Values
  current_lux: >
    {% if use_lux and lux_entity %}
      {{ states(lux_entity) | float(0) }}
    {% else %}
      0
    {% endif %}
  
  # Time Period Detection
  current_time: "{{ now().strftime('%H:%M:%S') }}"
  morning_start: !input morning_transition_start
  daytime_start: !input daytime_start
  daytime_end: !input daytime_end
  evening_start: !input evening_transition_start
  night_start: !input night_start
  night_end: !input night_end
  
  time_period: >
    {% set current = now().strftime('%H:%M:%S') %}
    {% set morning_s = morning_start %}
    {% set day_s = daytime_start %}
    {% set day_e = daytime_end %}
    {% set evening_s = evening_start %}
    {% set night_s = night_start %}
    {% set night_e = night_end %}
    
    {% if enable_circadian %}
      {% if night_e <= current < morning_s %}
        night
      {% elif morning_s <= current < day_s %}
        morning
      {% elif day_s <= current < day_e %}
        daytime
      {% elif day_e <= current < evening_s %}
        daytime
      {% elif evening_s <= current < night_s %}
        evening
      {% else %}
        night
      {% endif %}
    {% else %}
      {% if day_s <= current < day_e %}
        daytime
      {% else %}
        night
      {% endif %}
    {% endif %}
  
  # Get settings for current time period
  brightness: >
    {% set period = time_period %}
    {% if period == 'morning' %}
      {{ morning_brightness }}
    {% elif period == 'daytime' %}
      {{ daytime_brightness }}
    {% elif period == 'evening' %}
      {{ evening_brightness }}
    {% else %}
      {{ night_brightness }}
    {% endif %}
  
  color_temp: >
    {% set period = time_period %}
    {% if period == 'morning' %}
      {{ morning_color_temp }}
    {% elif period == 'daytime' %}
      {{ daytime_color_temp }}
    {% elif period == 'evening' %}
      {{ evening_color_temp }}
    {% else %}
      {{ night_color_temp }}
    {% endif %}
  
  timeout_duration: >
    {% set period = time_period %}
    {% if enable_workday and workday_entity %}
      {% if is_state(workday_entity, 'on') %}
        {{ workday_timeout }}
      {% else %}
        {{ weekend_timeout }}
      {% endif %}
    {% elif period == 'morning' %}
      {{ morning_timeout }}
    {% elif period == 'daytime' %}
      {{ daytime_timeout }}
    {% elif period == 'evening' %}
      {{ evening_timeout }}
    {% else %}
      {{ night_timeout }}
    {% endif %}
  
  # Lux-based brightness adjustment
  adjusted_brightness: >
    {% if use_lux and lux_entity %}
      {% set lux = current_lux %}
      {% if lux >= bright_lux %}
        {{ [brightness * 0.5, 10] | max | int }}
      {% elif lux <= dim_lux %}
        {{ brightness }}
      {% else %}
        {{ (brightness - ((lux - dim_lux) / (bright_lux - dim_lux)) * brightness * 0.5) | int }}
      {% endif %}
    {% else %}
      {{ brightness }}
    {% endif %}

trigger:
  - platform: state
    entity_id: !input motion_sensor
    to: 'on'
    id: motion_detected
  
  - platform: state
    entity_id: !input motion_sensor
    to: 'off'
    for: "{{ timeout_duration }}"
    id: motion_cleared

condition: []

action:
  - choose:
      # Motion Detected - Turn On Lights
      - conditions:
          - condition: trigger
            id: motion_detected
          
          # Check override switch
          - condition: template
            value_template: >
              {% if override_enabled and override_entity %}
                {{ is_state(override_entity, 'off') }}
              {% else %}
                true
              {% endif %}
          
          # Check fixed times
          - condition: template
            value_template: >
              {% if enable_fixed %}
                {% set current = now().strftime('%H:%M:%S') %}
                {% if disable_start < disable_end %}
                  {{ not (disable_start <= current < disable_end) }}
                {% else %}
                  {{ not (current >= disable_start or current < disable_end) }}
                {% endif %}
              {% else %}
                true
              {% endif %}
          
          # Check sun condition
          - condition: template
            value_template: >
              {% if sun_condition == 'always' %}
                true
              {% elif sun_condition == 'after_sunset' %}
                {{ is_state('sun.sun', 'below_horizon') }}
              {% elif sun_condition == 'before_sunrise' %}
                {{ is_state('sun.sun', 'below_horizon') }}
              {% elif sun_condition == 'sun_down' %}
                {{ is_state('sun.sun', 'below_horizon') }}
              {% else %}
                true
              {% endif %}
          
          # Check lux threshold
          - condition: template
            value_template: >
              {% if use_lux and lux_entity %}
                {{ current_lux < lux_threshold }}
              {% else %}
                true
              {% endif %}
        
        sequence:
          - service: light.turn_on
            target: !input target_lights
            data:
              brightness_pct: "{{ adjusted_brightness }}"
              color_temp: "{{ color_temp }}"
              transition: !input transition_time
          
          # Log if enabled
          - condition: template
            value_template: "{{ debug_logging }}"
          - service: system_log.write
            data:
              message: >
                Motion Light: Turned ON lights for {{ motion_entity }}. 
                Period: {{ time_period }}, Brightness: {{ adjusted_brightness }}%, 
                Color Temp: {{ color_temp }}, Lux: {{ current_lux }}
              level: "{{ log_level }}"
      
      # Motion Cleared - Turn Off Lights
      - conditions:
          - condition: trigger
            id: motion_cleared
        
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ restore_state and enable_snapshot }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: scene.motion_light_snapshot
            default:
              - service: light.turn_off
                target: !input target_lights
                data:
                  transition: !input transition_time
          
          # Log if enabled
          - condition: template
            value_template: "{{ debug_logging }}"
          - service: system_log.write
            data:
              message: >
                Motion Light: Turned OFF lights for {{ motion_entity }} after {{ timeout_duration }}s timeout
              level: "{{ log_level }}"